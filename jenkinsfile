pipeline {
    agent any
    environment {
            PATH = "/usr/local/bin:$PATH"
            DOCKER_IMAGE = "dineshkumarnilan/my-node-app:${env.BUILD_NUMBER}"
            NODE_ENV = "development"
            APP_PORT = "3000"
        }
        tools {
            nodejs("24.6.0")
        }
        stages {
            stage("checkout") {
            steps {
                checkout scm
                   }
            }

            stage("Docker Check") {
              steps {
                sh 'which docker'
                sh 'docker --version'
              }
            }

          stage("test") {
                steps {
                   sh 'npm version'
                   sh 'npm install'
                }
          }


          stage("build") {
                steps {
                    sh 'npm run build'
                }
            }

  stage("Build Docker Image") {
            steps {
                sh "docker build -t $DOCKER_IMAGE ."
            }
        }


        stage("Push Docker Image") {
                    steps {
                        withCredentials([usernamePassword(credentialsId: 'a7635359-c038-457c-9160-b50c8566b025', usernameVariable: 'dineshkumarnilan', passwordVariable: 'Nilan#@!12345')]) {
                            sh "docker push $DOCKER_IMAGE"
                        }
                    }
                }


                 stage("Deploy Docker Container") {
                            steps {
                                sh """
                                docker stop my-node-app || true
                                docker rm my-node-app || true
                                docker run -d --name my-node-app \
                                    -p $APP_PORT:3000 \
                                    -e NODE_ENV=$NODE_ENV \
                                    $DOCKER_IMAGE
                                """
                            }
                        }
    }
}
